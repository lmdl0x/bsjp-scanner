<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BSJP Auto Scanner ‚Äî Syariah IDX</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #07090f;
    --s1: #0d1117;
    --s2: #161b22;
    --s3: #1c2333;
    --border: rgba(48,70,120,0.6);
    --border2: rgba(48,70,120,0.3);
    --accent: #58a6ff;
    --accent2: #3fb950;
    --gold: #e3b341;
    --red: #f85149;
    --text: #c9d1d9;
    --text-dim: #8b949e;
    --text-muted: #30363d;
    --green: #3fb950;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  /* Top glow */
  .glow-top {
    position: fixed;
    top: -200px;
    left: 50%;
    transform: translateX(-50%);
    width: 800px;
    height: 400px;
    background: radial-gradient(ellipse, rgba(88,166,255,0.07) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    border-bottom: 1px solid var(--border);
    background: rgba(7,9,15,0.95);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-inner {
    height: 58px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .brand-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #1f6feb, #388bfd);
    border-radius: 8px;
    display: grid;
    place-items: center;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: #fff;
    letter-spacing: -0.5px;
    flex-shrink: 0;
  }

  .brand-name {
    font-size: 15px;
    font-weight: 700;
    letter-spacing: -0.3px;
    color: #e6edf3;
  }

  .brand-name span { color: var(--accent); }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .badge-syariah {
    background: rgba(227,179,65,0.1);
    border: 1px solid rgba(227,179,65,0.35);
    color: var(--gold);
  }

  .badge-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse-dot 2s ease-in-out infinite;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .clock {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ INDEX SELECTOR ‚îÄ‚îÄ */
  .index-bar {
    padding: 20px 0 0;
  }

  .index-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 12px;
  }

  .index-cards {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .index-card {
    flex: 1;
    min-width: 200px;
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    user-select: none;
  }

  .index-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 60%, rgba(88,166,255,0.05));
    opacity: 0;
    transition: opacity 0.2s;
  }

  .index-card:hover::before { opacity: 1; }
  .index-card:hover { border-color: rgba(88,166,255,0.5); }

  .index-card.active {
    border-color: var(--accent);
    background: rgba(88,166,255,0.06);
  }

  .index-card.active::before { opacity: 1; }

  .ic-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .ic-name {
    font-family: 'DM Mono', monospace;
    font-size: 16px;
    font-weight: 500;
    color: #e6edf3;
  }

  .ic-count {
    background: var(--s3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
  }

  .ic-active .ic-count {
    border-color: rgba(88,166,255,0.4);
    color: var(--accent);
  }

  .ic-desc {
    font-size: 12px;
    color: var(--text-dim);
    line-height: 1.4;
  }

  .ic-check {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #000;
    font-weight: 700;
  }

  .index-card.active .ic-check { display: flex; }

  /* ‚îÄ‚îÄ SCAN BUTTON ‚îÄ‚îÄ */
  .scan-bar {
    padding: 16px 0 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .btn-scan {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 11px 28px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .btn-scan:hover:not(:disabled) {
    background: #79b8ff;
    box-shadow: 0 0 20px rgba(88,166,255,0.35);
    transform: translateY(-1px);
  }

  .btn-scan:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-reset {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 11px 18px;
    background: var(--s1);
    color: var(--text-dim);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-reset:hover { border-color: rgba(88,166,255,0.5); color: var(--accent); }

  .scan-note {
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    margin-left: auto;
    text-align: right;
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
  .progress-wrap {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 20px;
    margin-bottom: 20px;
    display: none;
  }

  .progress-wrap.show { display: block; }

  .progress-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .progress-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
  }

  .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(88,166,255,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .progress-pct {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--accent);
  }

  .bar-track {
    height: 3px;
    background: var(--s3);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #388bfd, #58a6ff);
    border-radius: 2px;
    width: 0%;
    transition: width 0.4s ease;
  }

  .progress-log {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    max-height: 56px;
    overflow-y: auto;
    line-height: 1.9;
  }

  .log-pass { color: var(--green); }
  .log-fail { color: var(--text-muted); }
  .log-err { color: var(--red); }

  /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 20px;
    display: none;
  }

  .stats-grid.show { display: grid; }

  .stat-box {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
  }

  .stat-num {
    font-family: 'DM Mono', monospace;
    font-size: 26px;
    font-weight: 500;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-lbl {
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 0.3px;
  }

  /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
  .results-section { margin-bottom: 60px; display: none; }
  .results-section.show { display: block; }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .results-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .results-title .count-badge {
    background: rgba(63,185,80,0.15);
    border: 1px solid rgba(63,185,80,0.3);
    color: var(--green);
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    font-family: 'DM Mono', monospace;
  }

  .update-note {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
  }

  /* Empty pass state */
  .no-results {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 48px 20px;
    text-align: center;
    display: none;
  }

  .no-results.show { display: block; }
  .no-results-icon { font-size: 36px; opacity: 0.3; margin-bottom: 12px; }
  .no-results-title { font-size: 15px; font-weight: 600; color: #e6edf3; margin-bottom: 6px; }
  .no-results-desc { font-size: 12px; color: var(--text-dim); }

  /* Card grid for results */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 12px;
  }

  .stock-card {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .stock-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--green), #26a641);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s;
  }

  .stock-card:hover { border-color: rgba(63,185,80,0.4); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .stock-card:hover::after { transform: scaleX(1); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .card-ticker {
    font-family: 'DM Mono', monospace;
    font-size: 20px;
    font-weight: 500;
    color: #e6edf3;
    line-height: 1;
  }

  .card-index-tag {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
    font-family: 'DM Mono', monospace;
  }

  .card-price-block { text-align: right; }

  .card-price {
    font-family: 'DM Mono', monospace;
    font-size: 18px;
    font-weight: 500;
    color: #e6edf3;
    line-height: 1;
  }

  .card-change {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    margin-top: 3px;
  }

  .card-change.up { color: var(--green); }
  .card-change.dn { color: var(--red); }

  .card-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 14px;
  }

  .metric {
    background: var(--s2);
    border-radius: 8px;
    padding: 10px 12px;
  }

  .metric-label {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .metric-value {
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    color: #e6edf3;
  }

  .metric-value.ok { color: var(--green); }
  .metric-value.warn { color: var(--gold); }

  .card-criteria {
    display: flex;
    gap: 6px;
  }

  .crit {
    flex: 1;
    background: rgba(63,185,80,0.1);
    border: 1px solid rgba(63,185,80,0.25);
    border-radius: 6px;
    padding: 6px 4px;
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    font-weight: 500;
    color: var(--green);
    line-height: 1.2;
  }

  .crit span { display: block; font-size: 9px; color: rgba(63,185,80,0.6); margin-top: 2px; }

  /* ‚îÄ‚îÄ MODAL (chart) ‚îÄ‚îÄ */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(6px);
    padding: 20px;
  }

  .modal-backdrop.open { display: flex; }

  .modal {
    background: var(--s1);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 100%;
    max-width: 880px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: modal-in 0.2s ease;
  }

  @keyframes modal-in {
    from { opacity: 0; transform: scale(0.96) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .modal-info { display: flex; align-items: center; gap: 14px; }

  .modal-ticker {
    font-family: 'DM Mono', monospace;
    font-size: 20px;
    font-weight: 500;
    color: #e6edf3;
  }

  .modal-price {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    color: var(--text-dim);
  }

  .modal-change { font-family: 'DM Mono', monospace; font-size: 14px; }
  .modal-change.up { color: var(--green); }
  .modal-change.dn { color: var(--red); }

  .close-btn {
    width: 30px; height: 30px;
    background: var(--s2);
    border: 1px solid var(--border);
    border-radius: 7px;
    cursor: pointer;
    display: grid;
    place-items: center;
    color: var(--text-dim);
    font-size: 14px;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .close-btn:hover { color: #e6edf3; border-color: rgba(88,166,255,0.4); }

  .modal-body { padding: 16px 20px 20px; overflow-y: auto; flex: 1; }

  .tf-row {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
  }

  .tf-btn {
    padding: 6px 16px;
    border: 1px solid var(--border);
    background: none;
    border-radius: 7px;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .tf-btn.active { background: rgba(88,166,255,0.12); border-color: var(--accent); color: var(--accent); }
  .tf-btn:hover:not(.active) { border-color: rgba(88,166,255,0.4); color: var(--text); }

  .chart-wrap {
    width: 100%;
    height: 440px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: #000;
  }

  .chart-wrap iframe { width: 100%; height: 100%; border: none; }

  .modal-foot {
    margin-top: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
  }

  .modal-foot a { color: var(--accent); text-decoration: none; }
  .modal-foot a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
  }

  .empty-icon { font-size: 52px; margin-bottom: 16px; filter: grayscale(1) opacity(0.3); }
  .empty-title { font-size: 18px; font-weight: 700; color: #e6edf3; margin-bottom: 8px; }
  .empty-sub { font-size: 13px; color: var(--text-dim); max-width: 400px; margin: 0 auto; line-height: 1.7; }

  /* ‚îÄ‚îÄ SEPARATOR ‚îÄ‚îÄ */
  .divider {
    height: 1px;
    background: var(--border2);
    margin: 20px 0;
  }

  /* ‚îÄ‚îÄ SCROLL ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--s3); border-radius: 3px; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 700px) {
    .index-cards { flex-direction: column; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .cards-grid { grid-template-columns: 1fr; }
    .scan-note { display: none; }
  }

  /* ‚îÄ‚îÄ FOOTER NOTE ‚îÄ‚îÄ */
  .footer-note {
    border-top: 1px solid var(--border2);
    padding: 16px 0;
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    text-align: center;
    line-height: 1.8;
  }

  .footer-note span { color: var(--text-dim); }
</style>
</head>
<body>

<div class="glow-top"></div>

<header>
  <div class="container">
    <div class="header-inner">
      <div class="brand">
        <div class="brand-icon">BSJP</div>
        <div class="brand-name">Auto<span>Scanner</span></div>
      </div>
      <div class="header-meta">
        <div class="badge badge-syariah">
          <div class="badge-dot"></div>
          IDX Syariah
        </div>
        <div class="clock" id="clock">--:--:-- WIB</div>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- INDEX SELECTOR -->
  <div class="index-bar">
    <div class="index-label">Pilih Indeks</div>
    <div class="index-cards">
      <div class="index-card active" id="card-JII30" onclick="selectIndex('JII30')">
        <div class="ic-top">
          <div class="ic-name">JII30</div>
          <div class="ic-count" id="cnt-JII30">30 saham</div>
        </div>
        <div class="ic-desc">Jakarta Islamic Index ‚Äî 30 saham syariah paling likuid, top tier</div>
        <div class="ic-check">‚úì</div>
      </div>
      <div class="index-card" id="card-JII70" onclick="selectIndex('JII70')">
        <div class="ic-top">
          <div class="ic-name">JII70</div>
          <div class="ic-count" id="cnt-JII70">70 saham</div>
        </div>
        <div class="ic-desc">Jakarta Islamic Index 70 ‚Äî 70 saham syariah terpilih, kapitalisasi besar</div>
        <div class="ic-check">‚úì</div>
      </div>
      <div class="index-card" id="card-ISSI" onclick="selectIndex('ISSI')">
        <div class="ic-top">
          <div class="ic-name">ISSI</div>
          <div class="ic-count" id="cnt-ISSI">~200 saham</div>
        </div>
        <div class="ic-desc">Indeks Saham Syariah Indonesia ‚Äî seluruh saham syariah representatif di BEI</div>
        <div class="ic-check">‚úì</div>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <!-- KRITERIA INFO -->
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
    <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-dim);">
      <span style="background:rgba(88,166,255,0.1); border:1px solid rgba(88,166,255,0.3); color:var(--accent); padding:3px 8px; border-radius:5px; font-family:'DM Mono',monospace; font-size:10px;">C1</span>
      Harga ‚â• 1.05√ó kemarin
    </div>
    <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-dim);">
      <span style="background:rgba(88,166,255,0.1); border:1px solid rgba(88,166,255,0.3); color:var(--accent); padding:3px 8px; border-radius:5px; font-family:'DM Mono',monospace; font-size:10px;">C2</span>
      Harga ‚â• MA5
    </div>
    <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-dim);">
      <span style="background:rgba(88,166,255,0.1); border:1px solid rgba(88,166,255,0.3); color:var(--accent); padding:3px 8px; border-radius:5px; font-family:'DM Mono',monospace; font-size:10px;">C3</span>
      Volume ‚â• 1.2√ó kemarin
    </div>
    <div style="display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text-dim);">
      <span style="background:rgba(88,166,255,0.1); border:1px solid rgba(88,166,255,0.3); color:var(--accent); padding:3px 8px; border-radius:5px; font-family:'DM Mono',monospace; font-size:10px;">C4</span>
      Value &gt; Rp 1 Miliar
    </div>
  </div>

  <!-- SCAN BAR -->
  <div class="scan-bar">
    <button class="btn-scan" id="scanBtn" onclick="startScan()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      <span id="scanBtnTxt">Scan Sekarang</span>
    </button>
    <button class="btn-reset" onclick="resetAll()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      Reset
    </button>
    <div class="scan-note" id="scanNote">Pilih indeks lalu klik Scan<br>Data dari Yahoo Finance via proxy</div>
  </div>

  <!-- CUSTOM TAMBAHAN -->
  <div style="margin-bottom:16px;">
    <div style="font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;display:flex;align-items:center;gap:8px;">
      Ticker Tambahan
      <span style="font-size:10px;font-weight:400;letter-spacing:0;text-transform:none;color:var(--text-muted)">‚Äî opsional: tambahkan saham syariah di luar daftar indeks yang dipilih</span>
    </div>
    <div style="display:flex;gap:10px;align-items:flex-start;">
      <textarea id="customInput" placeholder="Contoh: ARGO INDR BUKK&#10;Pisahkan dengan spasi atau enter"
        style="flex:1;background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:10px 14px;
        color:var(--text);font-family:'DM Mono',monospace;font-size:12px;resize:none;height:58px;outline:none;
        transition:border-color 0.2s;"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea>
      <div style="font-size:11px;color:var(--text-muted);padding-top:8px;line-height:1.8;font-family:'DM Mono',monospace;white-space:nowrap;">
        Akan digabung<br>saat scan
      </div>
    </div>
  </div>

  <!-- PROGRESS -->
  <div class="progress-wrap" id="progressWrap">
    <div class="progress-top">
      <div class="progress-status">
        <div class="spinner" id="spinEl"></div>
        <span id="progressLabel">Memulai scan...</span>
      </div>
      <div class="progress-pct" id="progressPct">0%</div>
    </div>
    <div class="bar-track">
      <div class="bar-fill" id="barFill"></div>
    </div>
    <div class="progress-log" id="progressLog"></div>
  </div>

  <!-- STATS -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-box">
      <div class="stat-num" id="stTotal" style="color:var(--accent)">0</div>
      <div class="stat-lbl">Dipindai</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stPass" style="color:var(--green)">0</div>
      <div class="stat-lbl">Lulus BSJP</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stFail" style="color:var(--text-dim)">0</div>
      <div class="stat-lbl">Tidak Lulus</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stTime" style="color:var(--gold)">--</div>
      <div class="stat-lbl">Waktu Scan</div>
    </div>
  </div>

  <!-- NO PASS RESULTS -->
  <div class="no-results" id="noResults">
    <div class="no-results-icon">üîç</div>
    <div class="no-results-title">Tidak Ada Yang Lulus</div>
    <div class="no-results-desc">Tidak ada saham yang memenuhi semua 4 kriteria BSJP hari ini. Coba scan indeks lain atau cek kembali besok.</div>
  </div>

  <!-- RESULTS -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="results-title">
        Saham Lulus BSJP
        <span class="count-badge" id="passCount">0</span>
      </div>
      <div class="update-note" id="scanTime">-</div>
    </div>
    <div class="cards-grid" id="cardsGrid"></div>
  </div>

  <!-- EMPTY STATE (initial) -->
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">üì°</div>
    <div class="empty-title">Pilih Indeks & Scan</div>
    <div class="empty-sub">Pilih indeks syariah di atas (JII30 / JII70 / ISSI) lalu klik tombol Scan. Daftar saham sudah tersimpan ‚Äî tidak perlu input manual.</div>
  </div>

  <div class="footer-note">
    Data harga dari <span>Yahoo Finance</span> ¬∑ Chart dari <span>TradingView</span> ¬∑ Daftar konstituen per <span>Nov 2024‚ÄìMei 2025 (BEI/OJK)</span><br>
    Update daftar tiap Mei & Nov ¬∑ Bukan saran investasi ¬∑ DYOR
  </div>
</div>

<!-- CHART MODAL -->
<div class="modal-backdrop" id="modalBg" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-info">
        <div class="modal-ticker" id="mTicker">-</div>
        <div class="modal-price" id="mPrice">-</div>
        <div class="modal-change" id="mChange"></div>
      </div>
      <button class="close-btn" onclick="closeModalBtn()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="tf-row">
        <button class="tf-btn" onclick="setTF('30')" id="tf30">30m</button>
        <button class="tf-btn active" onclick="setTF('60')" id="tf60">1j</button>
        <button class="tf-btn" onclick="setTF('240')" id="tf240">4j</button>
        <button class="tf-btn" onclick="setTF('D')" id="tfD">1H</button>
      </div>
      <div class="chart-wrap">
        <iframe id="tvFrame" src=""></iframe>
      </div>
      <div class="modal-foot">
        Chart via TradingView ¬∑ <a id="tvDirectLink" href="#" target="_blank">Buka di TradingView ‚Üó</a>
      </div>
    </div>
  </div>
</div>

<script>
// ================================================================
// TICKER LISTS ‚Äî Sumber: syariahsaham.id / BEI / OJK
// JII30 ‚äÇ JII70 ‚äÇ ISSI
// ================================================================
const TICKERS = {

  JII30: [
    'AALI','ADRO','AKRA','ANTM','ASII',
    'BRIS','BRPT','CPIN','CTRA','EXCL',
    'HEAL','ICBP','INCO','INDF','INKP',
    'INTP','ISAT','ITMG','KLBF','MAPI',
    'MDKA','MIKA','MYOR','PGAS','PTBA',
    'SIDO','SMGR','TLKM','TPIA','UNTR'
  ],

  JII70: [
    'AALI','ACES','ADRO','AGII','AKRA',
    'ANTM','ASII','BANK','BRIS','BRPT',
    'BSDE','BTPS','CPIN','CTRA','DSNG',
    'ELSA','ERAA','EXCL','HEAL','HRUM',
    'ICBP','INCO','INDF','INKP','INTP',
    'ISAT','ITMG','JPFA','KLBF','LSIP',
    'MAPI','MDKA','MIKA','MNCN','MPMX',
    'MTDL','MYOR','PGAS','PRDA','PTBA',
    'PTPP','PWON','SCMA','SIDO','SMDR',
    'SMGR','SMRA','TAPG','TINS','TKIM',
    'TLKM','TPIA','UNTR','UNVR','WIKA',
    'BRMS','FILM','IRRA','ISSP','JPFA',
    'KPIG','LPKR','LPPF','MLPL','MMLP',
    'WIFI','BMTR','DMAS','BMHS','ENRG'
  ],

  // Daftar ISSI lengkap ‚Äî 556 saham per periode 2023 + update 2024-2025
  ISSI: [
    // Energi & Tambang
    'ENRG','MITI','SURE','AKRA','HITS','KOPI','MTFN','PGAS','RAJA','SHIP',
    'SOCI','ADRO','AIMS','ARII','BOSS','BSSR','BYAN','DSSA','GEMS','GTBO',
    'HRUM','ITMG','KKGI','MBAP','PTBA','SMMT','BBRM','BESS','DWGL','FIRE',
    'MBSS','PSSI','RIGS','SGER','TCPI','TEBE','TPMA','APEX','ELSA','DEWA',
    'ITMA','MYOH','PKPK','PTRO','TAMU','WINS','WOWS',
    // Kimia & Plastik
    'ADMG','AGII','BMSR','BRPT','FPNI','INCI','LTLS','MDKI','TPIA','UNIC',
    'SAMF','AKPI','APLI','CLPI','DPNS','EKAD','INTP','SMBR','SMCB','SMGR',
    'WTON','AYLS','ALDO','BRNA','EPAC','ESIP','IGAR','IPOL','KDSI','PANI',
    'PBID','SMKL','SPMA','TRST','YPAS',
    // Logam & Manufaktur
    'ALKA','ALMI','INAI','CITA','TBMS','PSAB','SQMI','BTON','CTBN','GDST',
    'GGRP','ISSP','LMSH','OPMS','ANTM','BRMS','DKFT','IFSH','INCO','TINS',
    'IFII','KAYU','INKP','INTD','TKIM',
    // Keramik & Kaca
    'AMFG','ARNA','CAKK','IMPC','KIAS','KOIN','MLIA','SINI','SPTO','TOTO',
    // Kabel & Elektronik
    'CCSI','IKBI','KBLI','KBLM','SCCO','VOKS',
    // Alat Berat & Otomotif
    'HEXA','KOBX','SKRN','UNTR','AMIN','APII','MARK','TIRA',
    'JTPE','BLUE','KONI','LION',
    // Jasa & IT
    'ASGR','ICON','MFMI','SOSS','TFAS','INDX','ABMM','BMTR','MLPL',
    // Perdagangan & Distribusi
    'DAYA','EPMT','SDPC','DMND','KMDS','PCAR','HERO','MIDI','MPPA','RANC',
    // F&B
    'ADES','CLEO','CAMP','KEJU','ULTJ','AISA','BUDI','CEKA','COCO','FOOD',
    'GOOD','HOKI','ICBP','INDF','MYOR','ROTI','SKBM','SKLT','STTP','TGKA',
    // Peternakan & Perikanan
    'AGAR','CPIN','CPRO','DSFI','ENZO','IKAN','JPFA','MAIN','SIPD','WMUU',
    // Perkebunan
    'AALI','ANDI','ANJT','BISI','CSRA','DSNG','FAPA','FISH','GZCO','LSIP',
    'PALM','PGUN','SGRO','SIMP','WAPO','TAPG',
    // Consumer
    'KINO','MBTO','MRAT','TCID','UCID','UNVR','VICI',
    // Otomotif parts
    'AUTO','BOLT','INDS','LPIN','SMSM','BRAM','GDYR','GJTL','MASA',
    // Furniture & Household
    'CBMF','CINT','GEMA','SOFA','WOOD','SCNP','KICI','LMPI','MICE',
    // Tekstil & Garmen
    'IIKP','TOYS','POLU','TRIS','BATA','BELL','INDR','SSTM','TFCO',
    // Hotel & Properti
    'ARTA','EAST','FITT','HRME','IKAI','JIHD','JSPT','KPIG','MAMI','MINA',
    'NASA','PGLI','PLAN','PNSE','PSKT','RISE','SHID','SOTS',
    // Pariwisata & Hiburan
    'BAYU','BLTZ','BOLA','JGLE','PJAA',
    // F&B Resto
    'CSMI','FAST','MAPB','PTSP','PZZA',
    // Teknologi & Media
    'YELO','WIFI','MNCN','SCMA','IPTV','MSKY','TMPO','FILM','MSIN','MKNT',
    // Retail
    'LPPF','RALS','MAPA','MAPI','ZONE','ECII','ERAA','SLIS','UFOE','ACES',
    'CSAP',
    // Otomotif dealer
    'BOGA','MPMX','PMJS','TURI',
    // Kesehatan
    'IRRA','DGNS','HEAL','MIKA','PRDA','PRIM','SAME','SILO','SRAJ',
    // Farmasi
    'DVLA','INAF','KAEF','KLBF','MERK','PEHA','SCPI','SIDO','SOHO','TSPC',
    // Bank & Keuangan Syariah
    'BANK','BRIS','BTPS','PNBS','JMAS','KREN','AMAN',
    // Properti
    'APLN','ASPI','ASRI','ATAP','BAPA','BAPI','BBSS','BCIP','BEST','BIKA',
    'BIPP','BKDP','BKSL','BSDE','CITY','CSIS','CTRA','DADA','DILD',
    'DMAS','DUTI','ELTY','FMII','GAMA','GPRA','GWSA','INPP','JRPT',
    'KIJA','LPKR','LPLI','MDLN','MKPI','MMLP','MORE','MPRO','MTLA',
    'MTSM','NIRO','NZIA','OMRE','PAMG','PLIN','PPRE','PRSR','PTPP',
    'PUDP','PWON','RBMS','RDTX','RODA','SFAN','SGRO','SMDM','SMRA',
    'TARA','TOTL','WGSH','WIKA','WSBP','WSKT',
    // Infrastruktur & Utilitas
    'BUKK','CMNP','JSMR','META','NCKL','PBSA','POWR','PORT','IPCM','IPCC',
    'KARW','ACST','TOWR','TBIG','EXCL','ISAT','TLKM',
    // Teknologi informasi
    'CASS','DCII','DMMX','MLPT','TECH','PTSN','LUCK','MTDL',
    'DIVA','HDIT','KIOS','MCAS','NFCX','PGJO',
    // Tambahan update 2024-2025
    'ARGO','MERI','MBMA','NCKL','AMMN','CBDK','RAJA','SRTG',
    'ESSA','GOTO','BBYB','BMHS','HELI','LABA','MSIE','RACK',
    // Tekstil tambahan
    'PBRX','RICY','STAR','UNIT',
    // Lain-lain syariah
    'ABDA','ACST','ADMF','AIMS','AISA','AKSI','ALTO','AMAG',
    'ANDI','ANJT','APII','APLN','ARNA','ASPI','ATAP','AVIA',
    'BBSS','BCIP','BFIN','BIKA','BIPP','BKDP','BIRD','BLTZ',
    'BOLT','BRAM','BRNA','BTON','BUDI','CAKK','CAMP','CASS',
    'CBMF','CCSI','CEKA','CENT','CINT','CITY','CLPI','COAL',
    'COCO','CPRO','CSAP','CSMI','CSRA','CTBN','DADA','DAYA',
    'DEWA','DGNS','DILD','DIMA','DIVA','DMND','DSSA','DUTI',
    'DVLA','DWGL','EAST','ECII','EKAD','ELTY','ENZO','EPAC',
    'EPMT','ERAA','ESIP','ESSA','FAST','FAPA','FIRE','FISH',
    'FITT','FMII','FPNI','GAMA','GDST','GDYR','GEMA','GEMS',
    'GGRP','GJTL','GOOD','GPRA','GTBO','GWSA','GZCO','HEXA',
    'HITS','HOKI','HRME','IKAI','IKAN','IKBI','IIKP','IMPC',
    'INAF','INAI','INCI','INDX','INDS','INPP','INTD','IPCC',
    'IPCM','IPOL','IPTV','IRRA','ISSP','ITMA','JIHD','JGLE',
    'JMAS','JRPT','JSPT','JTPE','KAEF','KARW','KAYU','KBLI',
    'KBLM','KDSI','KEJU','KIAS','KICI','KIJA','KINO','KMDS',
    'KOBX','KOIN','KONI','KOPI','KREN','LION','LMPI','LMSH',
    'LPLI','LPIN','LTLS','LUCK','MAIN','MAMI','MAPB','MASA',
    'MBAP','MBSR','MBTO','MCAS','MDKI','MDLN','MERK','META',
    'MICE','MIDI','MINA','MLIA','MNCN','MKNT','MKPI','MLPL',
    'MLPT','MMPZ','MORE','MPPA','MPRO','MRAT','MSKY','MSIE',
    'MSIN','MTDL','MTFN','MTLA','MTSM','MYOH','NASA','NFCX',
    'NIRO','NZIA','OMRE','OPMS','PALM','PAMG','PANI','PBID',
    'PBRX','PCAR','PGLI','PGJO','PKPK','PLAN','PLIN','PNBS',
    'PNSE','POLL','POLU','PORT','POWR','PPRE','PRDA','PRIM',
    'PRSR','PSAB','PSKT','PSSI','PTRO','PTSP','PUDP','PZZA',
    'RACK','RALS','RANC','RBMS','RDTX','RICY','RIGS','RISE',
    'RODA','ROTI','SAME','SAMF','SCCO','SCNP','SCPI','SFAN',
    'SGER','SGRO','SHID','SIMP','SINI','SIPD','SKBM','SKLT',
    'SLIS','SMDM','SOCI','SOFA','SOHO','SOSS','SOTS','SQMI',
    'SRAJ','SRTG','SSTM','STAR','STTP','SURE','SWAT','TBMS',
    'TECH','TFAS','TFCO','TGKA','TMPO','TOTO','TOYS','TPMA',
    'TRIS','TRST','TSPC','TURI','UCID','UFOE','UNIC','UNIT',
    'ULTJ','VICI','VOKS','WAPO','WGSH','WMUU','WSBP','WOWS',
    'WSKT','YPAS','YELO','ZONE'
  ]
};

// Deduplicate semua
Object.keys(TICKERS).forEach(k => {
  TICKERS[k] = [...new Set(TICKERS[k])];
});



// Update counts
document.getElementById('cnt-JII30').textContent = TICKERS.JII30.length + ' saham';
document.getElementById('cnt-JII70').textContent = TICKERS.JII70.length + ' saham';
document.getElementById('cnt-ISSI').textContent = TICKERS.ISSI.length + ' saham';

// ================================================================
// STATE
// ================================================================
let selectedIndex = 'JII30';
let scanning = false;
let passResults = [];
let currentTicker = '';
let currentTF = '60';

// ================================================================
// CLOCK
// ================================================================
function tick() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('id-ID', { timeZone: 'Asia/Jakarta' }) + ' WIB';
}
setInterval(tick, 1000);
tick();

// ================================================================
// INDEX SELECTOR
// ================================================================
function selectIndex(idx) {
  if (scanning) return;
  selectedIndex = idx;
  ['JII30', 'JII70', 'ISSI'].forEach(i => {
    document.getElementById('card-' + i).classList.toggle('active', i === idx);
  });
}

// ================================================================
// YAHOO FINANCE FETCH ‚Äî multi-proxy fallback, no AbortSignal
// ================================================================

// Timeout tanpa AbortSignal (menghindari postMessage clone error)
function fetchWithTimeout(url, ms) {
  return new Promise((resolve, reject) => {
    const t = setTimeout(() => reject(new Error('timeout')), ms);
    fetch(url)
      .then(r => { clearTimeout(t); resolve(r); })
      .catch(e => { clearTimeout(t); reject(e); });
  });
}

async function fetchStock(code) {
  const ticker = code + '.JK';
  // Coba query1 dulu, fallback ke query2
  const YAHOO_URLS = [
    `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=30d`,
    `https://query2.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=30d`,
  ];
  // Proxy list ‚Äî dicoba urut, berhenti saat berhasil
  const PROXIES = [
    u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    u => `https://corsproxy.io/?url=${encodeURIComponent(u)}`,
    u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  ];

  let rawText = null;
  let lastErr = 'all proxies failed';

  outer:
  for (const yahooUrl of YAHOO_URLS) {
    for (const makeProxy of PROXIES) {
      try {
        const proxyUrl = makeProxy(yahooUrl);
        const res = await fetchWithTimeout(proxyUrl, 12000);
        if (!res.ok) throw new Error(`http ${res.status}`);
        rawText = await res.text();
        if (rawText && rawText.length > 50) break outer; // sukses
        throw new Error('empty response');
      } catch (e) {
        lastErr = e.message;
      }
    }
  }

  if (!rawText) throw new Error(lastErr);

  let data;
  try { data = JSON.parse(rawText); } catch { throw new Error('parse error'); }

  // allorigins /get membungkus dalam {contents}, /raw tidak
  if (data && data.contents && typeof data.contents === 'string') {
    data = JSON.parse(data.contents);
  }

  const result = data?.chart?.result?.[0];
  if (!result) throw new Error('nodata');

  const closes = result.indicators.quote[0].close;
  const volumes = result.indicators.quote[0].volume;

  const valid = closes
    .map((c, i) => ({ c, v: volumes[i] }))
    .filter(x => x.c !== null && x.c !== undefined && x.v !== null && x.v > 0);

  if (valid.length < 6) throw new Error('insufficient');

  const last = valid[valid.length - 1];
  const prev = valid[valid.length - 2];
  const ma5 = valid.slice(-5).reduce((a, x) => a + x.c, 0) / 5;

  return {
    code,
    price: last.c,
    prevPrice: prev.c,
    volume: last.v,
    prevVolume: prev.v,
    ma5,
    value: last.c * last.v,
    change: (last.c - prev.c) / prev.c,
    volRatio: prev.v > 0 ? last.v / prev.v : 0,
  };
}

function check(d) {
  const c1 = d.price >= 1.05 * d.prevPrice;
  const c2 = d.price >= d.ma5;
  const c3 = d.volume >= 1.2 * d.prevVolume;
  const c4 = d.value > 1_000_000_000;
  return { c1, c2, c3, c4, pass: c1 && c2 && c3 && c4 };
}

// ================================================================
// FORMAT
// ================================================================
function fmtRp(v) {
  if (v >= 1e12) return 'Rp ' + (v / 1e12).toFixed(2) + ' T';
  if (v >= 1e9) return 'Rp ' + (v / 1e9).toFixed(2) + ' M';
  if (v >= 1e6) return 'Rp ' + (v / 1e6).toFixed(1) + ' Jt';
  return 'Rp ' + v.toLocaleString('id-ID');
}

function fmtPrice(v) {
  return 'Rp ' + v.toLocaleString('id-ID', { maximumFractionDigits: 0 });
}

function fmtPct(v) {
  return (v >= 0 ? '+' : '') + (v * 100).toFixed(2) + '%';
}

// ================================================================
// SCAN
// ================================================================
async function startScan() {
  if (scanning) return;
  scanning = true;
  passResults = [];

  // Gabungkan ticker indeks + custom input
  const customRaw = document.getElementById('customInput').value
    .toUpperCase().split(/[\s,;\n]+/).map(t => t.trim()).filter(t => t.length >= 2 && t.length <= 6);
  const baseTickers = TICKERS[selectedIndex];
  const tickers = [...new Set([...baseTickers, ...customRaw])];
  const t0 = Date.now();

  // UI: scanning state
  document.getElementById('scanBtn').disabled = true;
  document.getElementById('scanBtnTxt').textContent = 'Scanning...';
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('noResults').classList.remove('show');
  document.getElementById('resultsSection').classList.remove('show');
  document.getElementById('statsGrid').classList.remove('show');
  document.getElementById('progressWrap').classList.add('show');
  document.getElementById('progressLog').innerHTML = '';
  document.getElementById('barFill').style.width = '0%';
  document.getElementById('cardsGrid').innerHTML = '';

  let done = 0;
  let errors = 0;

  const addLog = (code, msg, cls) => {
    const el = document.getElementById('progressLog');
    el.innerHTML += `<div class="${cls}">${code}: ${msg}</div>`;
    el.scrollTop = el.scrollHeight;
  };

  const updateProgress = () => {
    const pct = Math.round((done / tickers.length) * 100);
    document.getElementById('barFill').style.width = pct + '%';
    document.getElementById('progressPct').textContent = pct + '%';
    document.getElementById('progressLabel').textContent =
      `Memindai ${selectedIndex} (${done}/${tickers.length})...`;
  };

  // Batch 4 at a time
  const BATCH = 4;
  for (let i = 0; i < tickers.length; i += BATCH) {
    const batch = tickers.slice(i, i + BATCH);
    await Promise.all(batch.map(async (code) => {
      try {
        const d = await fetchStock(code);
        const cr = check(d);
        done++;
        if (cr.pass) {
          passResults.push({ ...d, cr });
          addLog(code, `‚úì LULUS ‚Äî ${fmtPct(d.change)} | Vol√ó${d.volRatio.toFixed(1)}`, 'log-pass');
          renderCard({ ...d, cr }); // render immediately
        } else {
          addLog(code, `‚úó`, 'log-fail');
        }
      } catch (e) {
        done++;
        errors++;
        // Hanya tampilkan error jika bukan "Failed to fetch" / ticker tidak ada
        const msg = e.message || '';
        const isNotFound = msg.includes('fetch') || msg.includes('nodata') || msg.includes('insufficient');
        if (!isNotFound) {
          addLog(code, `err: ${msg}`, 'log-err');
        }
        // silent skip ‚Äî lanjut ke saham berikutnya
      }
      updateProgress();
    }));
    if (i + BATCH < tickers.length) await delay(250);
  }

  // Done
  const elapsed = ((Date.now() - t0) / 1000).toFixed(1) + 's';
  const fails = tickers.length - errors - passResults.length;

  document.getElementById('stTotal').textContent = tickers.length;
  document.getElementById('stPass').textContent = passResults.length;
  document.getElementById('stFail').textContent = fails;
  document.getElementById('stTime').textContent = elapsed;
  document.getElementById('statsGrid').classList.add('show');

  document.getElementById('progressLabel').textContent = 'Selesai!';
  document.getElementById('spinEl').style.display = 'none';

  document.getElementById('passCount').textContent = passResults.length;
  document.getElementById('scanTime').textContent =
    new Date().toLocaleTimeString('id-ID', { timeZone: 'Asia/Jakarta' }) + ' WIB';

  if (passResults.length === 0) {
    document.getElementById('noResults').classList.add('show');
  } else {
    document.getElementById('resultsSection').classList.add('show');
  }

  document.getElementById('scanNote').textContent =
    `${selectedIndex} ¬∑ ${passResults.length} lulus dari ${tickers.length}`;

  scanning = false;
  document.getElementById('scanBtn').disabled = false;
  document.getElementById('scanBtnTxt').textContent = 'Scan Ulang';
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// ================================================================
// RENDER CARD
// ================================================================
function renderCard(d) {
  const grid = document.getElementById('cardsGrid');
  const c = d.cr;
  document.getElementById('resultsSection').classList.add('show');

  const card = document.createElement('div');
  card.className = 'stock-card';
  card.onclick = () => openModal(d);
  card.innerHTML = `
    <div class="card-top">
      <div>
        <div class="card-ticker">${d.code}</div>
        <div class="card-index-tag">${selectedIndex} ¬∑ IDX SYARIAH</div>
      </div>
      <div class="card-price-block">
        <div class="card-price">${fmtPrice(d.price)}</div>
        <div class="card-change ${d.change >= 0 ? 'up' : 'dn'}">
          ${d.change >= 0 ? '‚ñ≤' : '‚ñº'} ${fmtPct(d.change)}
        </div>
      </div>
    </div>
    <div class="card-metrics">
      <div class="metric">
        <div class="metric-label">vs MA5</div>
        <div class="metric-value ok">${fmtPrice(d.ma5)}</div>
      </div>
      <div class="metric">
        <div class="metric-label">Vol Ratio</div>
        <div class="metric-value ok">${d.volRatio.toFixed(2)}√ó</div>
      </div>
      <div class="metric">
        <div class="metric-label">Value</div>
        <div class="metric-value ok">${fmtRp(d.value)}</div>
      </div>
      <div class="metric">
        <div class="metric-label">Harga Kemarin</div>
        <div class="metric-value">${fmtPrice(d.prevPrice)}</div>
      </div>
    </div>
    <div class="card-criteria">
      <div class="crit">C1<span>+5%</span></div>
      <div class="crit">C2<span>MA5</span></div>
      <div class="crit">C3<span>Vol</span></div>
      <div class="crit">C4<span>&gt;1M</span></div>
    </div>
  `;
  grid.appendChild(card);
}

// ================================================================
// RESET
// ================================================================
function resetAll() {
  if (scanning) return;
  passResults = [];
  document.getElementById('emptyState').style.display = '';
  document.getElementById('noResults').classList.remove('show');
  document.getElementById('resultsSection').classList.remove('show');
  document.getElementById('statsGrid').classList.remove('show');
  document.getElementById('progressWrap').classList.remove('show');
  document.getElementById('cardsGrid').innerHTML = '';
  document.getElementById('scanBtnTxt').textContent = 'Scan Sekarang';
  document.getElementById('scanNote').textContent = 'Pilih indeks lalu klik Scan\nData dari Yahoo Finance via proxy';
  document.getElementById('spinEl').style.display = '';
}

// ================================================================
// CHART MODAL
// ================================================================
function openModal(d) {
  currentTicker = d.code + '.JK';
  document.getElementById('mTicker').textContent = d.code;
  document.getElementById('mPrice').textContent = fmtPrice(d.price);
  const chEl = document.getElementById('mChange');
  chEl.textContent = (d.change >= 0 ? '‚ñ≤ ' : '‚ñº ') + fmtPct(d.change);
  chEl.className = 'modal-change ' + (d.change >= 0 ? 'up' : 'dn');
  document.getElementById('modalBg').classList.add('open');
  setTF(currentTF);
}

function setTF(tf) {
  currentTF = tf;
  ['30','60','240','D'].forEach(t => {
    document.getElementById('tf' + t)?.classList.toggle('active', t === tf);
  });
  const sym = 'IDX:' + currentTicker.replace('.JK','');
  const iframeUrl = `https://s.tradingview.com/widgetembed/?frameElementId=tv&symbol=${sym}&interval=${tf}&hidesidetoolbar=0&symboledit=0&saveimage=1&toolbarbg=161b22&theme=dark&style=1&timezone=Asia%2FJakarta&withdateranges=1&locale=id`;
  document.getElementById('tvFrame').src = iframeUrl;
  const direct = `https://www.tradingview.com/chart/?symbol=${sym}&interval=${tf}`;
  document.getElementById('tvDirectLink').href = direct;
}

function closeModal(e) {
  if (e.target === document.getElementById('modalBg')) closeModalBtn();
}

function closeModalBtn() {
  document.getElementById('modalBg').classList.remove('open');
  document.getElementById('tvFrame').src = '';
}

// Keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModalBtn();
});
</script>
</body>
</html>
